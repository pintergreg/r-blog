<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Leaflet choropleth</title>
  <meta name="description" content="Leaflet is an “an open-source JavaScript libraryfor mobile-friendly interactive maps”, that can plot GeoJSONs onto an OSM map. Of course using this for creat...">

  <link rel="stylesheet" href="/r-blog/css/main.css">
  <link rel="canonical" href="http://localhost:4000/r-blog/leaflet-choropleth">
  <link rel="alternate" type="application/rss+xml" title="My little R knowledgebase" href="http://localhost:4000/r-blog/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/r-blog/">My little R knowledgebase</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/r-blog/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Leaflet choropleth</h1>
    <p class="post-meta"><time datetime="2017-04-20T16:09:00+02:00" itemprop="datePublished">Apr 20, 2017</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="http://leafletjs.com/">Leaflet</a> is an “an open-source JavaScript library
for mobile-friendly interactive maps”, that can <a href="http://leafletjs.com/examples/geojson/">plot GeoJSONs</a> onto an OSM map. Of course using this for creating choropleths is also <a href="http://leafletjs.com/examples/choropleth/">possible</a>, but I lack the automatic value scaling. I was not the only one, so a <a href="https://github.com/timwis/leaflet-choropleth">very nice extension was created</a> for the task, called.</p>

<p>It has a <a href="https://github.com/timwis/leaflet-choropleth/blob/gh-pages/examples/basic/demo.js">basic example</a>, <a href="https://github.com/timwis/leaflet-choropleth/blob/gh-pages/examples/legend/demo.js">one for legends</a> and <a href="https://github.com/timwis/leaflet-choropleth/blob/gh-pages/examples/fetch_join/demo.js">another one for data merging</a>, but I put this together.</p>

<p>First load the necessary libraries:</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code>    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"leaflet.css"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"leaflet.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"jquery.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"choropleth.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre>
</div>

<p>Set the view, choose an <a href="http://wiki.openstreetmap.org/wiki/Tile_servers">image tile provider</a>, and add addribution data</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s2">"map"</span><span class="p">).</span><span class="nx">setView</span><span class="p">([</span><span class="mf">47.5</span><span class="p">,</span> <span class="mf">19.15</span><span class="p">],</span> <span class="mi">11</span><span class="p">);</span>

<span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="s2">"http://tile.stamen.com/toner/{z}/{x}/{y}.png"</span><span class="p">,</span> <span class="p">{</span> <span class="c1">// image provider</span>
    <span class="na">maxZoom</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
    <span class="na">attribution</span><span class="p">:</span> <span class="s1">'Map data &amp;copy; &lt;a href="http://openstreetmap.org"&gt;OpenStreetMap&lt;/a&gt; contributors, '</span> <span class="o">+</span>
        <span class="s1">'&lt;a href="http://creativecommons.org/licenses/by-sa/2.0/"&gt;CC-BY-SA&lt;/a&gt;, '</span> <span class="o">+</span>
        <span class="s1">'Imagery © &lt;a href="maps.stamen.com"&gt;stamen&lt;/a&gt;'</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="s1">'mapbox.light'</span>
<span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
</code></pre>
</div>

<p>Fetch GeoJSON and the data and merge them</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">$</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s2">"bp_grid_1000.geo.json"</span><span class="p">),</span> <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s2">"data.json"</span><span class="p">)).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">responseGeojson</span><span class="p">,</span> <span class="nx">responseData</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">responseData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">grid</span> <span class="o">=</span> <span class="nx">responseGeojson</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">grid</span><span class="p">[</span><span class="s2">"features"</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">cell_id</span> <span class="o">=</span> <span class="nx">grid</span><span class="p">[</span><span class="s2">"features"</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="s2">"properties"</span><span class="p">][</span><span class="s2">"id"</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">cell_id</span><span class="p">]){</span>
            <span class="nx">grid</span><span class="p">[</span><span class="s2">"features"</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="s2">"properties"</span><span class="p">][</span><span class="s2">"value"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">cell_id</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">grid</span><span class="p">[</span><span class="s2">"features"</span><span class="p">][</span><span class="nx">i</span><span class="p">][</span><span class="s2">"properties"</span><span class="p">][</span><span class="s2">"value"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre>
</div>

<p>Add the choropleth with automatic scaling into 7 categories</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">choroplethLayer</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">choropleth</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">valueProperty</span><span class="p">:</span> <span class="s2">"value"</span><span class="p">,</span> <span class="c1">// which property in the features to use</span>
    <span class="na">scale</span><span class="p">:</span> <span class="p">[</span><span class="s2">"white"</span><span class="p">,</span> <span class="s2">"yellow"</span><span class="p">,</span> <span class="s2">"red"</span><span class="p">,</span> <span class="s2">"black"</span><span class="p">],</span> <span class="c1">// chroma.js scale - include as many as you like</span>
    <span class="na">steps</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="c1">// number of breaks or steps in range</span>
    <span class="na">mode</span><span class="p">:</span> <span class="s2">"q"</span><span class="p">,</span> <span class="c1">// q for quantile, e for equidistant, k for k-means</span>
    <span class="na">style</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">color</span><span class="p">:</span> <span class="s2">"#ffffff"</span><span class="p">,</span> <span class="c1">// border color</span>
        <span class="na">weight</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="na">fillOpacity</span><span class="p">:</span> <span class="mf">0.85</span>
    <span class="p">},</span>
    <span class="na">onEachFeature</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">feature</span><span class="p">,</span> <span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">layer</span><span class="p">.</span><span class="nx">bindPopup</span><span class="p">(</span><span class="s2">"Cell "</span> <span class="o">+</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">"&lt;br&gt;"</span> <span class="o">+</span> <span class="s2">"value: "</span> <span class="o">+</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
</code></pre>
</div>

<p>Add legend (don’t forget to add the CSS from index.html), yeah that legend formatting should be much cleaner…</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">legend</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">control</span><span class="p">({</span> <span class="na">position</span><span class="p">:</span> <span class="s2">"bottomright"</span> <span class="p">})</span>
<span class="nx">legend</span><span class="p">.</span><span class="nx">onAdd</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">DomUtil</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s2">"div"</span><span class="p">,</span> <span class="s2">"info legend"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">limits</span> <span class="o">=</span> <span class="nx">choroplethLayer</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">limits</span>
    <span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="nx">choroplethLayer</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">colors</span>
    <span class="kd">var</span> <span class="nx">labels</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">"Legend"</span><span class="p">;</span>

    <span class="nx">limits</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">limit</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">labels</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">'&lt;li style="list-style-type: none;"&gt;&lt;span style="background-color: '</span> <span class="o">+</span> <span class="nx">colors</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">+</span> <span class="s1">'; width: 1em; height: 1em; display:inline-block; margin-right: 1ex; border: 0.5px solid #444; padding: 1px;"&gt;&lt;/span&gt;&lt;span style="vertical-align: top;"&gt;'</span> <span class="o">+</span> <span class="nx">limits</span><span class="p">[</span><span class="nx">prev</span><span class="p">].</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="o">+</span><span class="nx">limit</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'&lt;/span&gt;&lt;/li&gt;'</span><span class="p">)</span>
    <span class="p">})</span>

    <span class="nx">div</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="s1">'&lt;ul style="padding: 2px; margin: 1em 0 0 0"&gt;'</span> <span class="o">+</span> <span class="nx">labels</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'&lt;/ul&gt;'</span>
    <span class="k">return</span> <span class="nx">div</span>
<span class="p">}</span>
<span class="nx">legend</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span>
<span class="p">})</span>
</code></pre>
</div>

<h2 id="test-data-generation">Test data generation</h2>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"data.json"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">607</span><span class="p">)})),</span> <span class="nb">file</span><span class="o">=</span><span class="nb">file</span><span class="p">)</span>
</code></pre>
</div>

<h2 id="demo">Demo</h2>

<html>
    <head>
        <title>Leaflet Choropleth Tutorial</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="assets/leaflet/leaflet.css" />
        <script src="assets/leaflet/leaflet.js"></script>
        <script src="assets/leaflet/jquery.min.js"></script>
        <script src="assets/leaflet/choropleth.js"></script>

        <style>#map { width: 700px; height: 500px; }
    .info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } .info h4 { margin: 0 0 5px; color: #777; }
    .legend { text-align: left; line-height: 18px; color: #555; } .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }</style>
    </head>
    <body>
        <div id="map"></div>

        <script type="text/javascript">
            // Add a leaflet viewport
            var map = L.map("map").setView([47.5, 19.15], 11);

            L.tileLayer("http://tile.stamen.com/toner/{z}/{x}/{y}.png", {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                    '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                    'Imagery © <a href="maps.stamen.com">stamen</a>',
                id: 'mapbox.light'
            }).addTo(map);

            // Fetch GeoJSON and the data and merge them
            $.when($.getJSON("assets/leaflet/bp_grid_1000.geo.json"), $.getJSON("assets/leaflet/data.json")
                ).done(function (responseGeojson, responseData) {
                var data = responseData[0]
                var grid = responseGeojson[0]
                
                for (var i = 0; i < grid["features"].length; i++){
                    cell_id = grid["features"][i]["properties"]["id"];
                    if (data[cell_id]){
                        grid["features"][i]["properties"]["value"] = data[cell_id];
                    } else {
                        grid["features"][i]["properties"]["value"] = 0;
                    }
                }
            
            // Choropleth
            var choroplethLayer = L.choropleth(grid, {
                valueProperty: "value", // which property in the features to use
                scale: ["white", "yellow", "red", "black"], // chroma.js scale - include as many as you like
                steps: 7, // number of breaks or steps in range
                mode: "q", // q for quantile, e for equidistant, k for k-means
                style: {
                    color: "#ffffff", // border color
                    weight: 1,
                    fillOpacity: 0.85
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup("Cell " + feature.properties.id + "<br>" + "value: " + feature.properties.value)
                }
            }).addTo(map)


            // Add legend (don't forget to add the CSS from index.html)
            var legend = L.control({ position: "bottomright" })
            legend.onAdd = function (map) {
                var div = L.DomUtil.create("div", "info legend")
                var limits = choroplethLayer.options.limits
                var colors = choroplethLayer.options.colors
                var labels = []

                div.innerHTML = "Legend";

                limits.forEach(function (limit, index) {
                    var prev = index == 0 ? 0 : index - 1;
                    labels.push('<li style="list-style-type: none;"><span style="background-color: ' + colors[index] + '; width: 1em; height: 1em; display:inline-block; margin-right: 1ex; border: 0.5px solid #444; padding: 1px;"></span><span style="vertical-align: top;">' + limits[prev].toFixed(6) + ' - ' +limit.toFixed(6) + '</span></li>')
                })

                div.innerHTML += '<ul style="padding: 2px; margin: 1em 0 0 0">' + labels.join("") + '</ul>'
                return div
            }
            legend.addTo(map)
            })
        
        </script>
    </body>
</html>

<h2 id="misc">Misc</h2>

<p>Before realizing that Leaflet is exactly what I need I was playing with <a href="http://datamaps.github.io/">DataMaps</a>, which is build upon <a href="https://d3js.org/">D3.js</a>. It uses TopoJSON (?) by default and a <a href="https://github.com/d3/d3-geo/blob/master/README.md#projections">projection system</a> that allows one to create awesome interactive maps, but not really in that fashion I wanted.</p>

<p>I have my geo data in GeoJSON format, so I converted it to TopoJSON with a nice <a href="http://jeffpaine.github.io/geojson-topojson/">online tool for converting between GeoJSON and TopoJSON</a>.</p>

<p>A simple, “living” example can be found <a href="http://jsbin.com/pufejajama/edit?html,output">here</a>.</p>

<h3 id="a-few-tutorial-about-d3-mapping">A few tutorial about D3 mapping</h3>

<ul>
  <li>Mike Foster’s D3 Workshop material about <a href="http://duspviz.mit.edu/d3-workshop/mapping-data-with-d3/"><em>Mapping Data with D3</em></a> with simple examples.</li>
  <li><a href="http://www.tnoda.com/blog/2013-12-07">Another post</a> about using D3 for interactive maps.</li>
</ul>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">My little R knowledgebase</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>My little R knowledgebase</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/pintergreg"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">pintergreg</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>My "Today I Learned" posts mainly about R.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
